<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>내 IP 위치 보기</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-sA+e2r6bV6gkF3aQxk4jv+2wQfCk9w6Yk0w8qg9gYkM=" crossorigin=""/>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#60a5fa}
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,'Helvetica Neue',Arial; margin:0; min-height:100vh; background:linear-gradient(180deg,#071024 0%, #07182a 100%); color:#e6eef6; display:flex; align-items:center; justify-content:center; padding:24px}
    .wrap{width:100%; max-width:960px}
    header{display:flex; align-items:center; gap:12px; margin-bottom:16px}
    h1{font-size:20px; margin:0}
    p.lead{margin:0; color:var(--muted); font-size:13px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:16px; border-radius:12px; box-shadow:0 6px 24px rgba(2,6,23,0.6);}
    .grid{display:grid; grid-template-columns:320px 1fr; gap:16px}

    .info{display:flex; flex-direction:column; gap:10px}
    .row{background:rgba(255,255,255,0.02); padding:10px; border-radius:8px}
    .label{font-size:12px; color:var(--muted)}
    .value{font-weight:600; font-size:15px}

    #map{width:100%; height:420px; border-radius:10px; overflow:hidden}
    .controls{display:flex; gap:8px; margin-top:8px;}
    button{background:transparent; border:1px solid rgba(255,255,255,0.06); padding:8px 10px; border-radius:8px; color:inherit; cursor:pointer}
    button.primary{background:var(--accent); border-color:transparent; color:#07203a}
    small.note{display:block; margin-top:8px; color:var(--muted)}

    @media(max-width:880px){.grid{grid-template-columns:1fr;}.info{order:2}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="9" stroke="#60a5fa" stroke-width="1.2"/><path d="M12 7v5l3 2" stroke="#60a5fa" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div>
        <h1>내 IP 위치 보기</h1>
        <p class="lead">IP 기반 위치와 간단한 지도(Leaflet)를 표시합니다. 브라우저에서 열어 사용하세요.</p>
      </div>
    </header>

    <div class="card">
      <div class="grid">
        <div class="info">
          <div class="row">
            <div class="label">IP 주소</div>
            <div class="value" id="ip">불러오는 중...</div>
            <div class="controls">
              <button id="copyBtn">IP 복사</button>
              <button id="refreshBtn">새로고침</button>
            </div>
          </div>

          <div class="row">
            <div class="label">위치</div>
            <div class="value" id="location">불러오는 중...</div>
            <div class="label">도시 / 지역</div>
            <div id="city">—</div>
            <div class="label">국가</div>
            <div id="country">—</div>
            <div class="label">위도, 경도</div>
            <div id="coords">—</div>
          </div>

          <div class="row">
            <div class="label">ISP</div>
            <div id="isp">—</div>
            <div class="label">타임존</div>
            <div id="timezone">—</div>
          </div>

          <small class="note">참고: IP 기반 위치는 정확도가 제한적입니다. 더 정확한 위치는 브라우저의 위치 정보 권한을 사용해야 합니다.</small>
        </div>

        <div>
          <div id="map"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-o9N1j7kV+0v1q6Qq0eZs+q0wO7rjC4c6pG1n8r9A5+M=" crossorigin=""></script>
  <script>
    const ipEl = document.getElementById('ip');
    const locationEl = document.getElementById('location');
    const cityEl = document.getElementById('city');
    const countryEl = document.getElementById('country');
    const coordsEl = document.getElementById('coords');
    const ispEl = document.getElementById('isp');
    const tzEl = document.getElementById('timezone');
    const copyBtn = document.getElementById('copyBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    // 초기 지도 (세계보기)
    const map = L.map('map', {attributionControl:false}).setView([20,0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
    }).addTo(map);
    let marker = null;

    async function fetchIPInfo(){
      // ipapi.co 사용 (간편, CORS 허용)
      const apis = [
        'https://ipapi.co/json/',
        'https://ipinfo.io/json?token=', // 토큰이 없으면 일부 정보가 제한될 수 있음
      ];

      ipEl.textContent = '불러오는 중...';
      try {
        // 우선 ipapi.co로 시도
        const res = await fetch(apis[0]);
        if(!res.ok) throw new Error('api 실패');
        const data = await res.json();
        // ipapi 응답은: ip, city, region, country_name, latitude, longitude, org, timezone
        showData({
          ip: data.ip || '—',
          city: (data.city || data.region) || '—',
          region: data.region || '—',
          country: data.country_name || data.country || '—',
          lat: data.latitude || data.lat || null,
          lon: data.longitude || data.lon || null,
          isp: data.org || data.org || '—',
          timezone: data.timezone || '—'
        });
        return;
      } catch(e){
        console.warn('ipapi 실패, 대체 API 시도', e);
      }

      try {
        const res2 = await fetch(apis[1]);
        if(!res2.ok) throw new Error('대체 api 실패');
        const d2 = await res2.json();
        // ipinfo 제공 포맷: ip, city, region, country, loc ("lat,lon"), org, timezone
        const [lat, lon] = d2.loc ? d2.loc.split(',') : [null, null];
        showData({
          ip: d2.ip || '—',
          city: d2.city || d2.region || '—',
          region: d2.region || '—',
          country: d2.country || '—',
          lat: lat, lon: lon,
          isp: d2.org || '—',
          timezone: d2.timezone || '—'
        });
        return;
      } catch(e){
        console.error('모든 API 실패', e);
        ipEl.textContent = '불러오기 실패';
        locationEl.textContent = '정보 없음';
        cityEl.textContent = countryEl.textContent = coordsEl.textContent = ispEl.textContent = tzEl.textContent = '—';
      }
    }

    function showData(d){
      ipEl.textContent = d.ip || '—';
      const place = [d.city, d.region, d.country].filter(Boolean).join(', ');
      locationEl.textContent = place || '—';
      cityEl.textContent = d.city || '—';
      countryEl.textContent = d.country || '—';
      ispEl.textContent = d.isp || '—';
      tzEl.textContent = d.timezone || '—';
      if(d.lat && d.lon){
        coordsEl.textContent = `${d.lat}, ${d.lon}`;
        const lat = parseFloat(d.lat);
        const lon = parseFloat(d.lon);
        map.setView([lat, lon], 11);
        if(marker) marker.setLatLng([lat, lon]);
        else marker = L.marker([lat, lon]).addTo(map);
        marker.bindPopup(`<strong>IP:</strong> ${d.ip}<br><strong>위치:</strong> ${place}`).openPopup();
      } else {
        coordsEl.textContent = '위도/경도 정보 없음';
      }
    }

    copyBtn.addEventListener('click', ()=>{
      const text = ipEl.textContent || '';
      if(!text || text === '불러오는 중...' || text === '불러오기 실패') return;
      navigator.clipboard.writeText(text).then(()=>{
        copyBtn.textContent = '복사됨';
        setTimeout(()=>copyBtn.textContent = 'IP 복사',1200);
      }).catch(()=>alert('복사 실패'));
    });

    refreshBtn.addEventListener('click', ()=>{
      fetchIPInfo();
    });

    // 최초 실행
    fetchIPInfo();
  </script>
</body>
</html>
